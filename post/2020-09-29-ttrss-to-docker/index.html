<!DOCTYPE html>
<html lang="en-Us">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>TTRSS to Docker &middot; Slices of a hacker&#39;s mind</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Slices of a hacker&#39;s mind" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Slices of a hacker&#39;s mind</h2>
				</a>
				<ul>
    <li><a href="/contact">About</a></li>
    <li><a href="/flash">Flash Posts</a></li>
    <li><a href="/post">Posts</a></li>
    <li><a href="/search">Search</a></li>
    <li><a href="/privacy">Privacy</a></li>
</ul>

			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        akendo
        <span>on&nbsp;</span><time datetime="2020-09-29 11:40:02 &#43;0200 CEST">September 29, 2020</time>
        <br>
        <span>5 minutes reading </span>

    
         <span> posted in  
    
        
          <a href="https://blog.akendo.eu/categories/linux/">linux</a>
    </span>

</div>

		<h1 class="post-title">TTRSS to Docker</h1>
<div class="post-line"></div>

		

		<p>Some time ago I wrote about the <a href="https://blog.akendo.eu/post/2014-01-05-tinytiny-rss/">TinyTiny RSS</a>. I did shutdown the service in 2017 because the server it was running got de-provisioned. But everything was stored on a backup.</p>
<p>Since I got some time to spare I&rsquo;ve decided to re-active the TT-RSS instance, however, because I lack the server I&rsquo;ve moved it to a small system at home. It should be run on a docker container. The project itself provides a <a href="https://git.tt-rss.org/fox/ttrss-docker-compose/src/master/docker-compose.yml">docker-compose</a> file to work with, including some updated to the base image to be more &lsquo;secure&rsquo;.</p>
<pre><code>  db:
    restart: always
    image: 'postgres:13-alpine'
    volumes:
      - &quot;./volumes/postgresql:/var/lib/postgresql/data&quot;
    environment:    
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
  ttrss:
    ports:
      - &quot;9000:9000&quot;
    build: 
      context:
        ./ttrss
    restart: unless-stopped
    environment:
      - DB_TYPE=pgsql
      - DB_HOST=db
      - DB_NAME=${POSTGRES_USER}
      - DB_USER=${POSTGRES_USER}
      - DB_PASS=${POSTGRES_PASSWORD}
      - OWNER_UID=${OWNER_UID}
      - OWNER_GID=${OWNER_GID}
      - SELF_URL_PATH=${SELF_URL_PATH}
    volumes:
      - &quot;./volumes/ttrss/:/var/www/html&quot;
    depends_on:
      - db

</code></pre><p>I ported the <code>app</code> and <code>db</code> from the offical <a href="https://git.tt-rss.org/fox/ttrss-docker-compose/src/master/docker-compose.yml">docker-compose</a> to my personal docker-compose file to have it integreated with my pre-existing infrastructure. The first start was not quite successful, why? The ported parts included only the app but it was leaking the CGI export from Caddy. It is necessary to run it with the Caddy service to forward it correctly. So I copied it down the web entry:</p>
<pre><code>  web:
    environment:
      - VIRTUAL_HOST=ttrss
      - VIRTUAL_PORT=2015
    build: ./web
    restart: unless-stopped
    volumes:
      - &quot;./volumes/ttrss/:/var/www/html:ro&quot;
    depends_on:
      - ttrss
</code></pre><p>Once you&rsquo;re started with it you almost having it. On this point you need to update the <code>.env</code> to include the correct hostname. I&rsquo;m using a nginx-proxy that reads out the environment variables of the docker-compose file for the hostname parameter. It will listen on that hostname and forward the traffic to the corresponding container. Once this is configured you&rsquo;re can access the service. The hostname it will serve is http://ttrss.</p>
<p>At this stage I didn&rsquo;t know the password the service was using be default. My quick solution was to check for the password with in the databases and google the hash. Its &lsquo;password&rsquo;&hellip; gosh I should have tested that.</p>
<p>There is a problem. The setup does not support a separated databases user. Why? Because it tries to create a database extension for the given database, something only the super user is allowed to do.</p>
<p>To workaround the database user issue I&rsquo;ve tried to alter the installation script for this with no success.
I dislike running DB via docker, it feels unnatural because the container makes a lot of assumption for instance that it will be run in a &lsquo;embedded&rsquo; fashion. Meaning that you&rsquo;re not going to login into the postgres datbases, however, that exactly what a postgres requires you to do. This adds quite some pain to the process of importing an older backup the fresh docker installation. I copied the backup dump into the volume.</p>
<p>The import was not quite working because on my server installation I used a seperated User to access the data. However, the postgres dumb did not include the role creation. The pity here is that the role name and the databases name are the same: rss.</p>
<p>That seems dumb in hindsight, so renaming the key word is not well suitded. Besides, the databases tables names often include the phrasing, you guess it, rss. Hence renaming the databases dumb to use a seperated role or username seems to be more work.</p>
<p>Prepere the migration</p>
<p>I need to check what version the databases had before shutdown and look for migrations. Technically, this should be handled by the application automatilly.</p>
<p>The data will be copied with
docker cp rss.sql docker-grafana_db_1:/var/lib/postgres</p>
<p>My current stragetgy is to just load the data into the postgres databases and hope that it does work.</p>
<p>The creation will cause the database rss to be created.</p>
<p>The current version of my db was:</p>
<pre><code>rss=# SELECT * FROM ttrss_version 
rss-# ;
 schema_version 
----------------
            126
</code></pre><p>The latest one is</p>
<pre><code>postgres=# SELECT * FROM ttrss_version;
 schema_version 
----------------
            140
</code></pre><p>However, I just rember one thing. Instead of hacking my way around of the missing user, why not just extract the data from the VM?
The orignal dump only the rss db,A</p>
<pre><code>CREATE ROLE rss;
ALTER ROLE rss WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION PASSWORD 'md5ab8a5e09ff96de5abe63442691e7a944';
</code></pre><p>Looking at the pg_dumpall I&rsquo;ve got the idea to create the User, make it to the SuperUser let ttrss setup and THAN drop the priviledge.</p>
<p>Anyway back to the migration:</p>
<pre><code>postgres=# CREATE ROLE rss;
CREATE ROLE
postgres=# ALTER ROLE rss WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION PASSWORD 'rss';
ALTER ROLE
postgres=# ^D\q
bash-5.0# psql -U postgres
psql (13.0)
Type &quot;help&quot; for help.

postgres=# DROP DATABASE rss;
</code></pre><p>After the first successful import I&rsquo;ve created the user new. I got the creation from the pg_dumpall</p>
<p>We create the db first and then we import the data into it. Next is to exec a shell in the ttrss container and reconfigure it to use the
rss db instead. We do not have to start the exec, because the files is within the volumes datapoint on the fs.</p>
<p>To test with that it uses the db correctly I invoked the update_daemon2.php</p>
<p>/ # sudo -u app /usr/bin/php /var/www/html/tt-rss/update_daemon2.php
[16:54:00/84] Spawn interval: 120 sec
Schema version is wrong, please upgrade the database.</p>
<p>So we need invoke it without the old running service.</p>
<p>Next is to check the config.php and stop the default</p>
<p>docker-compose run ttrss sh</p>
<p>And here we go. There was some funny</p>
<pre><code>alter table ttrss_feeds add constraint ttrss_feeds_feed_url_owner_uid_key unique (feed_url, owner_uid)
</code></pre><p>However that causes some error. It seems that there was a row duplicated in place. I had to drop the entry that was double. TTRSS was to kind to display an error with the row that was duplicated. It took two minutes and it was gone. Once the duplicated row was deleted it the databases migration was no issue.</p>
<p>The first update took quite some time until all was updated.</p>
<p>So what necessary to get it going?
Run the container, update the configuration file after the deployment. Importe the databases with the porper role pre-existing. Makesure that the feeds are not duplicated and then keep it running.</p>
<p>So how does it look in the end:</p>
<pre><code>$ docker-compose ps
            Name                          Command               State                       Ports                     
----------------------------------------------------------------------------------------------------------------------
docker-grafana_db_1            docker-entrypoint.sh postgres    Up      5432/tcp                                      
docker-grafana_nginx-proxy_1   /app/docker-entrypoint.sh  ...   Up      0.0.0.0:80-&gt;80/tcp                            
docker-grafana_ttrss_1         /bin/sh -c /startup.sh           Up      0.0.0.0:9000-&gt;9000/tcp, 0.0.0.0:9001-&gt;9001/tcp
docker-grafana_web_1           /bin/parent caddy --conf / ...   Up      2015/tcp, 443/tcp, 80/tcp  
</code></pre><p>After this it became necesary to get the update into the docker-compose file.</p>


		
	</div>

	<div class="pagination">
		<a href="/flash/23.09.2020-linkdrop/" class="left arrow">&#8592;</a>
		<a href="/flash/04.10.2020-linkdrop/" class="right arrow">&#8594;</a>

        <p><a rel="license" href="https://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="pictures/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p>


		<a href="#" class="top">Top</a>
	</div>

</main>



        		<footer>
			<span>
			&copy; <time datetime="2020-10-04 16:37:06.110470721 &#43;0200 CEST m=&#43;0.228507302">2020</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
