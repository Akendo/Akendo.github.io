<!DOCTYPE html>
<html lang="en-Us">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Kernel Exploitation Part Four &middot; Slices of a hacker&#39;s mind</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Slices of a hacker&#39;s mind" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Slices of a hacker&#39;s mind</h2>
				</a>
				<ul>
    <li><a href="/contact">About</a></li>
    <li><a href="/flash">Flash Posts</a></li>
    <li><a href="/post">Posts</a></li>
    <li><a href="/search">Search</a></li>
    <li><a href="/privacy">Privacy</a></li>
</ul>

			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        akendo
        <span>on&nbsp;</span><time datetime="2021-02-07 23:17:37 &#43;0100 CET">February 7, 2021</time>
        <br>
        <span>3 minutes reading </span>
         <span> posted in 
    
        <a href="https://blog.akendo.eu/categories/security/">Security</a>
	
    
	
    </span>
    <span>
    <br>
    
 
  with tags:
   <a href="https://blog.akendo.eu/tags/kernel/">kernel</a> <a href="https://blog.akendo.eu/tags/100daystooffload/">100daystooffload</a></ul>



</div>

		<h1 class="post-title">Kernel Exploitation Part Four</h1>
<div class="post-line"></div>

		

		<p>This post is the fourth part of my notes from the lecture about kernel exploitation of pwn.college[0]. Read the previous post first:</p>
<ul>
<li><a href="/post/2021-02-01-kernel-exploitation-part-one/">Here</a> about first part.</li>
<li><a href="/post/2021-02-02-kernel-exploitation-part-two/">Here</a> about the second part.</li>
<li><a href="post/2021-02-04-kernel-exploitation-part-three/">Here</a> about the second thrid.</li>
</ul>
<h3 id="switching-between-rings">Switching between rings</h3>
<p><img src="/pictures/Kernel-Introduction6.jpg" alt=""></p>
<p>This slide made more sense after staring at it for a while. Because we started to define what rings are and how we are affected by them. Now, we want to know how such a switch occurs.</p>
<p>Any computer will boot with ring 0 enabled by default. I wrote about the boot process in my bachelor theses[1]. I did not write that detail. But it is safe to assume that the process is in real mode after power-up. It also includes that it is in ring 0. What is to remember here is that this is a historical aspect of CPUs. These things are part of the  CPU that has to be present to ensure that nothing is breaking because it might be possible that SOMEONE still uses it! Intel can not afford this.</p>
<p>That reminded me of a different but similar problem within the industry, to stick to old working standards. Microsoft had vulnerabilities[3] that weren’t able to be fixed because it would break customer applications.  Essential this was the reason why SMB v1 was kept for so long in windows until the NSA leak. Leading to the situation that even Windows 10 systems were being affected. Microsoft has disabled SMBv1 now. But there are more of such things in Windows and most likely in Intel too.</p>
<p>Obviously, we are not bothered with the boot process too much here. Once the kernel is loaded, we’re back into the course. Before I return to the lecture, I was wondering about that <code>MSR_LSTAR</code> .</p>
<p>After searching within the Linux kernel sources about it, I found this definition[2]. The value of <code>MSR_LSTAR</code> will be translated to <code>0xc0000082</code>. Does that mean that written data are just dropped through into the register of the CPU? It is just a register? Somehow I feel stupid now because it did not make much sense until now.</p>
<p>Maybe&hellip;For instance, in some assembler code sample, there are using syscalls by writing into some special memory address. I think that is what is happening here as well. I guess that’s what he is implying within the video that everything is just the same, just a bit more special.</p>
<p>Ah, so your kernel sees that there is a pointer within the <code>MSR_LSTAR</code> register. That triggers the kernel to switch into ring 0. Then the CPU executes the code and once it completed it writes the return address into <code>RCX</code>.</p>
<p>Ah, so your kernel sees that there is a pointer within the MSR_LSTAR register. That triggers the kernel to switch into ring 0. Then the CPU executes the code until it finishes it.
Afterward, it will write the return address into <code>RCX</code> and will drop the privileges. This will be indicated by the keyword &lsquo;CPL&rsquo;. It resembles CPU Privilege Level in this context. Lastly the kernel will return the regular execution with the pointer stored in <code>RCX</code>.</p>
<p>Gosh I think I got it.</p>
<p>so far,<br>
akendo</p>
<p>[0] <a href="https://pwn.college/modules/kernel">https://pwn.college/modules/kernel</a> <br>
[1] <a href="https://blog.akendo.eu/post/2019.06.10-securing-hardware-with-coreboot/#boot-process">https://blog.akendo.eu/post/2019.06.10-securing-hardware-with-coreboot/#boot-process</a> <br>
[2] <a href="https://github.com/torvalds/linux/search?q=MSR_LSTAR">https://github.com/torvalds/linux/search?q=MSR_LSTAR</a></p>


		
	</div>

	<div class="pagination">
		<a href="/post/2021-02-07-review-cw5/" class="left arrow">&#8592;</a>
		<a href="/post/2021-02-10-hugo-youtube-shortcode/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>

</main>



        		<footer>
			
			<span>
			&copy; <time datetime="2023-04-30 22:28:19.985564791 &#43;0200 CEST m=&#43;0.164704427">2023</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
